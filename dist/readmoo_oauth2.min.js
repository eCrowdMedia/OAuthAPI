/*! readmoo_oauth2 - v1.0.0-alpha - 2013-08-23
* Copyright (c) 2013 Kevin Chiu; Licensed  */
var hello=function(){"use strict";function a(a,c){if(i(c.network,c),!("display"in C)||"page"!==C.display){var d=window.opener||window.parent;if(d&&"hello"in d&&d.hello){var e=c.callback;try{delete c.callback}catch(f){}c.error?d.hello.trigger(c.network+":"+e+".failed",c):(d.hello.utils.store(c.network,c),d.hello.trigger(c.network+":"+e+".login",{network:c.network,authResponse:c})),i(c.network,c)}return window.close(),b("Trying to close window"),void 0}}function b(){}function c(a){if(!a)return!0;if(a&&a.length>0)return!1;if(a&&0===a.length)return!0;for(var b in a)if(a.hasOwnProperty(b))return!1;return!0}function d(a,b){for(var c=[],d=0;d<b.length;d++)-1===f(a,b[d])&&c.push(b[d]);return c}function e(a,b){var c="HTML"+(a||"").replace(/^[a-z]/,function(a){return a.toUpperCase()})+"Element";return window[c]?b instanceof window[c]:window.Element?b instanceof window.Element&&(!a||b.tagName===a):!(b instanceof Object||b instanceof Array||b instanceof String||b instanceof Number)&&b.tagName&&b.tagName===a}function f(a,b){if(a.indexOf)return a.indexOf(b);for(var c=0;c<a.length;c++)if(a[c]===b)return c;return-1}function g(a,b){if(b){var d;for(var e in b)a.indexOf(e)>-1&&(d=new RegExp("[?&]"+e+"=[^&]*"),a=a.replace(d,""))}return a+(c(b)?"":(a.indexOf("?")>-1?"&":"?")+h(b))}function h(a){var c,d,e={};if("string"==typeof a){if(d=a.replace(/^[\#\?]/,"").match(/([^=\/\&]+)=([^\&]+)/g),b(d),d)for(var f=0;f<d.length;f++)c=d[f].split("="),e[c[0]]=decodeURIComponent(c[1]);return e}var g=a;e=[];for(var h in g)g.hasOwnProperty(h)&&g.hasOwnProperty(h)&&e.push([h,"?"===g[h]?"?":encodeURIComponent(g[h])].join("="));return e.join("&")}function i(a,b){var c=JSON.parse(localStorage.getItem("hello"))||{};if(a&&"undefined"==typeof b)return c[a];if(a&&""===b)try{delete c[a]}catch(d){c[a]=null}else{if(!a)return c;c[a]=b}return localStorage.setItem("hello",JSON.stringify(c)),c}function j(a){if("object"!=typeof a)return[];for(var b=[],c=0;c<a.length;c++)a[c]&&0!==a[c].length&&-1===f(b,a[c])&&b.push(a[c]);return b}function k(a,b){var c,d={};if("object"==typeof a&&"object"==typeof b){for(c in a)a.hasOwnProperty(c)&&(d[c]=a[c],c in b&&(d[c]=k(a[c],b[c])));for(c in b)b.hasOwnProperty(c)&&(c in a||(d[c]=b[c]))}else d=b;return d}function l(a,c){var d={},e=0,f=null,g=null;for(g in a)if(a.hasOwnProperty(g))break;if(1===c.length&&"object"==typeof c[0]&&"o!"!=a[g])return c[0];for(g in a)if(a.hasOwnProperty(g))if(f=typeof c[e],"function"==typeof a[g]&&a[g].test(c[e])||"string"==typeof a[g]&&(a[g].indexOf("s")>-1&&"string"===f||a[g].indexOf("o")>-1&&"object"===f||a[g].indexOf("i")>-1&&"number"===f||a[g].indexOf("a")>-1&&"object"===f||a[g].indexOf("f")>-1&&"function"===f))d[g]=c[e++];else if("string"==typeof a[g]&&a[g].indexOf("!")>-1)return b("Whoops! "+g+" not defined"),!1;return d}function m(a){for(0===a.indexOf("/")?a=window.location.protocol+"//"+window.location.host+a:a.match(/^https?\:\/\//)||(a=(window.location.href.replace(/#.*/,"").replace(/\/[^\/]+$/,"/")+a).replace(/\/\.\//g,"/"));/\/[^\/]+\/\.\.\//g.test(a);)a=a.replace(/\/[^\/]+\/\.\.\//g,"/");return a}function n(a,c,d){var e="string"==typeof a?document.createElement(a):a;if("object"==typeof c)if("tagName"in c)d=c;else for(var f in c)if(c.hasOwnProperty(f))if("object"==typeof c[f])for(var g in c[f])c[f].hasOwnProperty(g)&&(e[f][g]=c[f][g]);else"html"===f?e.innerHTML=c[f]:/^on/.test(f)?e[f]=c[f]:e.setAttribute(f,c[f]);return"body"===d?function h(){document.body?document.body.appendChild(e):setTimeout(h,16)}():"object"==typeof d?d.appendChild(e):"string"==typeof d&&(b(d),document.getElementsByTagName(d)[0].appendChild(e)),e}function o(a,b,c,d,e,f){var h=B.getAuthResponse(a),i=y[a],j=h?h.access_token:null,k=i.oauth&&1===parseInt(i.oauth.version,10)?B.settings.oauth_proxy:null;if(k)if("GET"!==c.toUpperCase()){var l=g(k,{path:b,access_token:j||"",method:c});"withCredentials"in new XMLHttpRequest?p(c,l,null,d,f):q(g(l,{callback:"?",data:JSON.stringify(d)}),f)}else f(g(k,{path:b,access_token:j||""}));else{var m={access_token:j||""};e&&e(m),f(g(b,m))}}function p(a,b,d,e,f){if("function"!=typeof b){var h=b;b=function(a,b){b(g(h,a))}}var i=new XMLHttpRequest,j=!1;"blob"===a&&(j=a,a="GET"),a=a.toUpperCase(),i.onload=function(){var b=i.response;try{b=JSON.parse(i.responseText)}catch(c){401===i.status&&(b={error:{code:"access_denied",message:i.statusText}})}f(b||("DELETE"!==a?{error:{message:"Could not get resource"}}:{}),i.status)},i.onerror=function(){var a=i.responseText;try{a=JSON.parse(i.responseText)}catch(b){}f(a||{error:{code:"access_denied",message:"Could not get resource"}})};var l,m={};if("GET"===a||"DELETE"===a)c(e)||(m=k(m,e)),e=null;else if(e&&"string"!=typeof e&&!(e instanceof FormData)){var n=new FormData;for(l in e)e.hasOwnProperty(l)&&(e[l]instanceof HTMLInputElement?"files"in e[l]&&e[l].files.length>0&&n.append(l,e[l].files[0]):n.append(l,e[l]));e=n}return b(m,function(b){if(i.open(a,b,!0),j&&("responseType"in i?i.responseType=j:i.overrideMimeType("text/plain; charset=x-user-defined")),d)for(var c in d)i.setRequestHeader(c,d[c]);i.send(e)}),i}function q(a,b){var c,d,e="__lx_jsonp"+u++,f=0,h=document.getElementsByTagName("head")[0],i={error:{message:"server_error",code:"server_error"}},j=function(){f++||window.setTimeout(function(){b(i),h.removeChild(d)},0)};if("function"!=typeof a){var k=a;k=k.replace(new RegExp("=\\?(&|$)"),"="+e+"$1"),a=function(a,b){b(g(k,a))}}window[e]=function(a){i=a;try{delete window[e]}catch(b){}},a(function(a){for(var b in a)a.hasOwnProperty(b)&&"?"===a[b]&&(a[b]=e)},function(a){d=n("script",{id:e,name:e,src:a,async:!0,onload:j,onerror:j,onreadystatechange:function(){/loaded|complete/i.test(this.readyState)&&j()}}),window.navigator.userAgent.toLowerCase().indexOf("opera")>-1&&(c=n("script",{text:"document.getElementById('"+e+"').onerror();"}),d.async=!1),window.setTimeout(function(){i={error:{message:"timeout",code:"timeout"}},j()},x),h.appendChild(d),c&&h.appendChild(c)})}function r(a,c,d,f){if("function"!=typeof a){var h=a;a=function(a,b){b(g(h,a))}}var i,j=null,k=[],l=0,m=null,n=0,o=function(a){if(!n++){try{i&&i.parentNode.removeChild(i)}catch(c){b("could not remove iframe")}for(var d=0;d<k.length;d++)k[d]&&k[d].setAttribute("disabled",!1);f(a)}},p="ifrmhack_"+parseInt(1e6*Math.random(),10).toString(16);window[p]=o;var q;try{q=document.createElement('<iframe name="'+p+'">')}catch(r){q=document.createElement("iframe")}q.name=p,q.id=p,q.style.display="none",d&&d.callbackonload&&(q.onload=function(){o({response:"posted",message:"Content was posted"})}),setTimeout(function(){o({error:{code:"timeout",message:"The post operation timed out"}})},x),document.body.appendChild(q);var s={redirect_uri:B.settings.redirect_uri,state:JSON.stringify({callback:p})};if(e("form",c)){for(j=c.form,l=0;l<j.elements.length;l++)j.elements[l]!==c&&j.elements[l].setAttribute("disabled",!0);c=j}if(e("form",c))for(j=c,l=0;l<j.elements.length;l++)j.elements[l].disabled||"file"!==j.elements[l].type||(j.encoding=j.enctype="multipart/form-data",j.elements[l].setAttribute("name","file"));else{for(m in c)c.hasOwnProperty(m)&&e("input",c[m])&&"file"===c[m].type&&(j=c[m].form,j.encoding=j.enctype="multipart/form-data");j||(j=document.createElement("form"),document.body.appendChild(j),i=j);for(m in c)if(c.hasOwnProperty(m)){var t=e("input",c[m])||e("textArea",c[m])||e("select",c[m]);if(t&&c[m].form===j)t&&c[m].name!==m&&(c[m].setAttribute("name",m),c[m].name=m);else{j.elements[m]&&j.elements[m].parentNode.removeChild(j.elements[m]);var u=document.createElement("input");u.setAttribute("type","hidden"),u.setAttribute("name",m),u.value=t?c[m].value:e(null,c[m])?c[m].innerHTML||c[m].innerText:c[m],j.appendChild(u)}}for(l=0;l<j.children.length;l++)j.children[l].name in c||j.children[l].getAttribute("disabled")===!0||(j.children[l].setAttribute("disabled",!0),k.push(j.children[l]))}j.setAttribute("method","POST"),j.setAttribute("target",p),j.target=p,a(s,function(a){j.setAttribute("action",a),setTimeout(function(){j.submit()},100)})}function s(a){for(var b in a)if(a.hasOwnProperty(b)&&(e("input",a[b])&&"file"===a[b].type||"FileList"in window&&a[b]instanceof window.FileList||"File"in window&&a[b]instanceof window.File||"Blob"in window&&a[b]instanceof window.Blob))return!0;return!1}function t(a){var c=a.data;if(e("form",c)){for(var d=c.elements,f={},g=0;g<d.length;g++)if("file"===d[g].type){if("FormData"in window){f[d[g].name]=d[g];break}if(!("files"in d[g]))return!1}else f[d[g].name]=d[g].value||d[g].innerHTML;c=f}if(e("input",c)){if(!("files"in c))return!1;var h={};h[c.name]=c.files,c=h}if(("File"in window&&c instanceof window.File||"Blob"in window&&c instanceof window.Blob||"FileList"in window&&c instanceof window.FileList)&&(c={file:c}),!("FormData"in window&&c instanceof window.FormData))for(var i in c)if(c.hasOwnProperty(i))if("FileList"in window&&c[i]instanceof window.FileList)1===c[i].length?c[i]=c[i][0]:b("We were expecting the FileList to contain one file");else if(e("input",c[i])&&"file"===c[i].type){if(!("files"in c[i]))return!1}else e("input",c[i])||e("select",c[i])||e("textArea",c[i])?c[i]=c[i].value:e(null,c[i])&&(c[i]=c[i].innerHTML||c[i].innerText);return a.data=c,!0}var u=0,v={},w={position:"absolute",left:"-1000px",bottom:0,height:"1px",width:"1px"},x=2e4,y={},z={},A={};!function H(){for(var a in y)if(y.hasOwnProperty(a)){if(!y[a].id)continue;var c=B.getAuthResponse(a)||{},d=z[a]||{};if(c&&"callback"in c&&c.callback in v){var e=c.callback;try{delete c.callback}catch(f){}i(a,c),B.trigger(e,{network:a,authResponse:c})}if(c&&"expires"in c&&c.expires<(new Date).getTime()/1e3){(!(a in A)||A[a]<(new Date).getTime()/1e3)&&(b(a+" has expired trying to resignin"),B.login(a,{display:"none"}),A[a]=(new Date).getTime()/1e3+600);continue}if(d.access_token===c.access_token&&d.expires===c.expires)continue;!c.access_token&&d.access_token?B.trigger(a+":auth.logout",{network:a,authResponse:c}):c.access_token&&!d.access_token?B.trigger(a+":auth.login",{network:a,authResponse:c}):c.expires!==d.expires&&B.trigger(a+":auth.update",{network:a,authResponse:c}),z[a]=c}setTimeout(H,1e3)}();var B={settings:{redirect_uri:window.location.href.split("#")[0],response_type:"token",display:"popup",state:"",oauth_proxy:"https://auth-server.herokuapp.com/proxy"},service:function(a){return"undefined"!=typeof a?i("sync_service",a):i("sync_service")},init:function(a){if(!a)return y;var b=l({services:"o!",opts:"o",timeout:"i"},arguments);for(var c in b.services)b.services.hasOwnProperty(c)&&"object"!=typeof b.services[c]&&(b.services[c]={id:b.services[c]});y=k(y,b.services);for(c in y)y.hasOwnProperty(c)&&(y[c].scope=y[c].scope||{});return b.opts&&(this.settings=k(this.settings,b.opts),"redirect_uri"in b.opts&&(this.settings.redirect_uri=m(b.opts.redirect_uri))),b.timeout&&(x=b.timeout),y},login:function(){var a,c=l({network:"s!",options:"o",callback:"f"},arguments);c.options=k(this.settings,c.options||{}),"string"!=typeof c.network&&b("Please specify a service.");var e=y[c.network],h=""+Math.round(1e9*Math.random()),i=!1;this.subscribe(h,function x(){i=!0,B.unsubscribe(h,x),c.callback&&c.callback.apply(this,arguments)});var o=k(c.options,{client_id:e.id,scope:"basic",state:{client_id:e.id,network:c.network,display:c.options.display,callback:h,state:c.options.state,oauth_proxy:c.options.oauth_proxy}}),p=c.options.scope;p&&"string"!=typeof p&&(p=p.join(",")),p=(p?p+",":"")+o.scope,o.state.scope=p.split(/,\s/),o.scope=p.replace(/[^,\s]+/gi,function(a){return a in e.scope?e.scope[a]:""}).replace(/[,\s]+/gi,","),o.scope=j(o.scope.split(/,+/)).join(e.scope_delim||",");var q=B.getAuthResponse(c.network);if(q&&"expires"in q&&q.expires>(new Date).getTime()/1e3){var r=d(q.scope||[],o.state.scope||[]);if(0===r.length)return this.trigger(h+".login",{network:c.network,authResponse:q}),void 0}o.redirect_uri=m(o.redirect_uri),e.oauth&&(o.state.oauth=e.oauth),o.state=JSON.stringify(o.state);for(var s in o)o.hasOwnProperty(s)&&-1===f(["response_type","redirect_uri","state","client_id","scope","display"],s)&&delete o[s];if(e.auth_options&&(o=k(o,e.auth_options)),a=e.oauth&&1===parseInt(e.oauth.version,10)?g(c.options.oauth_proxy,o):g(e.uri.auth,o),"none"===c.options.display)n("iframe",{src:a,style:w},"body");else if("popup"===c.options.display){var t=window.open(a,"Authentication","resizeable=true,height=550,width=500,left="+(window.innerWidth-500)/2+",top="+(window.innerHeight-550)/2);t.focus();var u=this,v=setInterval(function(){t.closed&&(clearInterval(v),i||u.trigger(h+".failed",{error:{code:"user_cancelled",message:"Cancelled"},network:c.network}))},100)}else window.location=a;return{url:a,method:o.display}},logout:function(){var a=l({name:"s",callback:"f"},arguments);if(a.name&&i(a.name))i(a.name,"");else if(a.name)b(a.name+" had no session");else{for(var c in y)y.hasOwnProperty(c)&&B.logout(c);B.service(!1)}a.callback&&a.callback(!1)},api:function(){var a=l({path:"s!",method:"s",data:"o",timeout:"i",callback:"f"},arguments);a.method=(a.method||"get").toLowerCase(),a.data=a.data||{},a.path=a.path.replace(/^\/+/,"");var d,e=(a.path.split(/[\/\:]/,2)||[])[0].toLowerCase();if(e in y){d=e;var f=new RegExp("^"+e+":?/?");a.path=a.path.replace(f,"")}else d=this.service();a.callback=a.callback||function(){},x=a.timeout||x,b("API: "+a.method.toUpperCase()+" '"+a.path+"' (request)",a);var h=y[d];if(!h)return b("No user"),a.callback(!1),void 0;var i=function(c,d){if(h.wrap&&(a.path in h.wrap||"default"in h.wrap)){var e=a.path in h.wrap?a.path:"default",f=(new Date).getTime();c=h.wrap[e](c,d),b("Processig took"+((new Date).getTime()-f))}b("API: "+a.method.toUpperCase()+" '"+a.path+"' (response)",c),a.callback(c,d)};if(a.path in h.uri&&h.uri[a.path]===!1)b('The path "'+a.path+'" is not recognised');else{var j=a.path in h.uri?h.uri[a.path]:h.uri["default"]?h.uri["default"]:a.path,m=function(b){b.match(/^https?:\/\//)||(b=h.uri.base+b);var e={},f=function(c,f){c&&("function"==typeof c?c(e):e=k(e,c));var i=g(b,e||{});o(d,i,a.method,a.data,h.querystring,f)};if(!c(a.data)&&!t(a))return r(f,a.data,"post"in h?h.post(a):null,i),void 0;if("delete"===a.method){var j=i;i=function(a,b){j(!a||c(a)?{response:"deleted"}:a,b)}}if("withCredentials"in new XMLHttpRequest&&(!("xhr"in h)||h.xhr&&h.xhr(a,e))){e.suppress_response_codes=!0;var l=p(a.method,f,a.headers,a.data,i);return{xhr:l,method:"XHR",data:a.data}}return"jsonp"in h&&h.jsonp(a,e),"post"===a.method?{url:r(f,a.data,"post"in h?h.post(a):null,i),method:"POST",data:a.data}:(e=k(e,a.data),e.callback="?",{url:q(f,i),method:"JSONP"})};"function"==typeof j?j(a,m):m(j)}},getAuthResponse:function(a){return i(a||this.service())},subscribe:function(a,c){b("Subscribed",a,c);var d=l({evt:"s!",callback:"f!"},arguments);return d?(v[d.evt]=[d.callback].concat(v[d.evt]||[]),void 0):!1},unsubscribe:function(a,c){b("Unsubscribe",a,c);var d=l({evt:"s!",callback:"f"},arguments);if(!d)return!1;for(var e=0;e<v[d.evt].length;e++)d.callback&&v[d.evt][e]!==d.callback||(v[d.evt]=v[d.evt].splice(e,1))},trigger:function(a,c){b("Trigger: '"+a+"'",c);for(var d in v)if(v.hasOwnProperty(d)&&a.indexOf(d)>-1)for(var e=0;e<v[d].length;e++)v[d][e].call(this,c)},utils:{param:h,hasBinary:s,sign:o,store:i,append:n,merge:k}},C=k(h(window.location.search||""),h(window.location.hash||""));if(C&&"state"in C){try{var D=JSON.parse(C.state);C=k(C,D)}catch(E){b("Could not decode state parameter")}"access_token"in C&&C.access_token&&C.network?(C.expires_in&&0!==parseInt(C.expires_in,10)||(C.expires_in=C.expires_id?2592e3:3600),C.expires_in=parseInt(C.expires_in,10),C.expires=(new Date).getTime()/1e3+parseInt(C.expires_in,10),B.service(C.network),a(C.network,C)):"error"in C&&C.error&&C.network&&(C.error={code:C.error,message:C.error_message||C.error_description},a(C.network,C)),C&&C.callback&&"result"in C&&C.result&&C.callback in window.parent&&window.parent[C.callback](JSON.parse(C.result))}if(C=h(window.location.search),C.code&&C.state||C.oauth_token&&C.proxy_url){C.redirect_uri=window.location.href.replace(/[\?\#].*$/,"");var F=JSON.parse(C.state),G=(F.oauth_proxy||C.proxy_url)+"?"+h(C);window.location=G}return B}();!function(){var a,b,c,d,e,f;f=["reading","highlight","like","comment","me","library"],e="http://korprulu.ohread.com/test/oauth2/test/",b="b4c5026fcd9d9eeec642d09e8402036f",a={readmoo:"efe60b2afc3447dded5e6df6fd2bd920"},c={redirect_uri:e,scope:f.join(),response_type:"code"},hello.subscribe("auth.login",function(){return console.log("login success")}),hello.init(a,c),window.readmoo=d={},d.login=function(){return hello.login("readmoo")}}.call(this),function(){hello.init({readmoo:{name:"Readmoo",uri:{auth:"https://readmoo.com/member/oauth",me:"https://api.readmoo.com/me",base:"https://api.readmoo.com/"},oauth:{version:2,grant:"https://readmoo.com/member/oauth/access_token"},scope:{reading:"reading",highlight:"highlight",like:"like",comment:"comment",library:"library"}}})}.call(this);